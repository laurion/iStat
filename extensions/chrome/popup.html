<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>iStat_ext</title>
		<link href="styles.css" rel="stylesheet" type="text/css"> 
        <style>
            body {margin:0;padding:0;font-family:Helvetica, Arial, sans-serif;width:600px;font-size:13px;overflow:hidden;}
        </style>
	    <script type=text/javascript src='jquery.js'></script>
	    <script>
	    	$(document).ready(function(){
                buildUrlList();
                $("body").width("600");
                $("body").css("background-color", "#FFFFFF");
                $(".title").css("color", "#858586");
                $(".subtitle").css("color", "#A5B7A5");
                $(".links .details").css("border-bottom", "1px solid "+ "#F1F8FF");
                $(".links .details:last-child").css("border-bottom", "none");
                
                $(".details").hover(function () {
                    $(this).css("background-color", "#CDE5FF");
                }, function () {
                    $(this).css("background-color", "#FFFFFF");
                });
            });
			 
			
			function buildUrlList() {
				
				chrome.tabs.getSelected(null, function(tab) {
			    	window.tabUrl=tab.url;
			    	//alert(tabUrl);
			  	});
				alert(window.tabUrl);
			  	//var data = []; // empty array

			  	var req = new XMLHttpRequest();
				req.open(
				    "GET",
				    "http://localhost:8000/api/most-visited" +
				        "?website=" +
				        tabUrl,
				    true);
				req.onreadystatechange=function() {
					if (req.readyState==4) {
						//alert("status: " + req.status);
						if(req.status!=404){
							var items = JSON.parse(req.responseText);
			                var $links = $("<div/>", {class: "links"});
			                
			                for(var i=0;i<items.pages.length;i++) {
			
			                    var title = items.pages[i].title ? items.pages[i].title : items.pages[i].long_url;
			                    var url = .replace(/^\w+\:\/\//, "");
			
			                    //fara slash
			                    if(url.charAt(url.length-1) == "/") {
			                        url = url.substr(0, url.length-1);
			                    }
			                    
			                    var $details = $("<div/>", {class:"details"});
			                  
			                    
			                    var $info = $("<div/>", {class:"info"})
			                                    .data("url", items.pages[i].long_url)
			                                    .mousedown(function(event) {
			                                        var clickedUrl = $(this).data("url");
			                                        chrome.tabs.create({url:clickedUrl, selected: true});
			                                        return false;
			                                    });
			                    
			                    
			                    var $title = $("<div/>", {class:"title", text: title});
			                    var $subtitle = $("<div/>", {class:"subtitle", text: url});
			                
			                    $info.append($title);
			                    $info.append($subtitle);
			                    $details.append($info); 
			                    $links.append($details);
			                }
			                $("body").append($links);
						}
					}
				}

				req.send(null);
			}

	    </script>
	    <!-- <script type=text/javascript src='json2.js'></script> -->
	    
		<meta name="author" content="laurion">
		<!-- Date: 2011-05-01 -->
	</head>

	<body onload="buildUrlList();" style="height: 1000px;" >
	    <h2>iStat Page Statistics:</h2>
	    <div id='url_div'></div>

 	</body>
</html>
